<!DOCTYPE html>
<html lang="en"> 
<head>
<title>Gladiators</title>
<meta content="text/html; charset=UTF-8" http-equiv="content-type">
<meta name="viewport" content="width=device-width, initial-scale=1">
<meta name="title" content="Gladiators">
<meta name="description" content="Game">
<button onclick="MoveRight()"> This is a button </button>
<link rel="icon" type="image/png" href="glario.png"> 
<link rel="stylesheet" type="text/css" href="style.css"> 
<link rel="manifest" href="manifest.manifest">
</head>
<body onload="">
<div class="maindiv" id="maindiv">
<div class="canvasdiv" id="canvasdiv">
<canvas class="canvas"id="canvas" width="360" height="360">
Your web browser does not support canvas.
</canvas>

<button> This is a button for advance right</button>
<button> This is a button for advance left</button>
</div>
</div><!-- maindiv -->

</body>
<script type="text/javascript">
      /*    
        @licstart  The following is the entire license notice for the 
        JavaScript code in this page.

        Copyright (C) 2022  mrbonjour

        The JavaScript code in this page is free software: you can
        redistribute it and/or modify it under the terms of the GNU
        General Public License (GNU GPL) as published by the Free Software
        Foundation, either version 3 of the License, or (at your option)
        any later version.  The code is distributed WITHOUT ANY WARRANTY;
        without even the implied warranty of MERCHANTABILITY or FITNESS
        FOR A PARTICULAR PURPOSE.  See the GNU GPL for more details.

        As additional permission under GNU GPL version 3 section 7, you
        may distribute non-source (e.g., minimized or compacted) forms of
        that code without the copy of the GNU GPL normally required by
        section 4, provided you include this license notice and a URL
        through which recipients can access the Corresponding Source.   


        @licend  The above is the entire license notice
        for the JavaScript code in this page.
        */
// audio

var audiobg = new Audio('mega.ogg');
audiobg.play(); 
audiobg.loop = true; 
var audiosword = new Audio('sword.ogg');
var audiosword2 = new Audio('sword2.ogg'); 
var audiohup = new Audio('twink.ogg');
var audiojump = new Audio('BonusCube.ogg');
var jupiterloading = new Audio('jupiter_loading.wav'); 



// IMAGES
var heroAUf=new Image();
var	heroAPf=new Image();

var Archer1actor_y = 0; 


var hero=new Image();
var herol=new Image();
var herowf1=new Image();
var herowf2=new Image();
var herowf3=new Image();
var herowfl1=new Image();
var herowfl2=new Image();
var herowfl3=new Image();
var column=new Image();
var jupiter0=new Image();
var jupiter1=new Image();
var jupiterR=new Image();
var jupiterL=new Image();
var heroCI=new Image();
var heroCPA=new Image();
var heroCUA=new Image();
var heroSPC=new Image();
var heroSPS=new Image();
var fletxaL=new Image();
var fletxaR=new Image();
var heroAPFLL=new Image();
var heroAUFL=new Image();
var heroCIL=new Image();
var heroCPAL=new Image();
var heroCUAL=new Image();
var heroSPSL=new Image();
var heroAPFL=new Image();
var archer=new Image();
var archerR=new Image();
var coliseum=new Image();
var columns=new Image();
var blood=new Image();
var healthimage=new Image();
var wall=new Image();
var HUDHeroPlayerHP=new Image();
var HUDEnemyBossHP=new Image();
var ArcherDead=new Image();
var glario=new Image();
ScreenCompletedEmpty=new Array(360);

ScreenCompletedEmpty[0] = true; 


var screenarray1=new Array(360);
for (var i=-100;i<460;i++) 
	{
	screenarray1[i]=new Array(360);
	}
for (var j=-100;j<460;j++) 
	{
	for (var i=-100;i<460;i++) 
    	{
	    screenarray1[j][i]=".";//formateja array
	    }
    }
j=60+128;
for (var i=150;i<250;i++) 
	{
    screenarray1[j][i]="p";//plataforma 1
    }
j=120+128;
for (var i=250;i<360;i++) 
	{
    screenarray1[j][i]="p";//plataforma 2
    } 
j=180+128; 
 for (var i=-100;i<460;i++) 
	{
    screenarray1[j][i]="p";//plataforma 3
    }
///////////////////////////////////////////////////////////////////////////////
var screenarray2=new Array(360);
for (var i=-100;i<460;i++) 
	{
	screenarray2[i]=new Array(360);
	}
for (var j=-100;j<460;j++) 
	{
	for (var i=-100;i<460;i++) 
    	{
	    screenarray2[j][i]=".";//formateja array
	    }
    }
j=180+128;
for (var i=-100;i<150;i++) 
	{
    screenarray2[j][i]="p";//plataforma 1
    }
j=180+128;
for (var i=250;i<460;i++) 
	{
    screenarray2[j][i]="p";//plataforma 2
    } 
j=120+128; 
 for (var i=150;i<250;i++) 
	{
    screenarray2[j][i]="p";//plataforma 3
    }
screenarray2[100+128][200]="h";
///////////////////////////////////////////////////////////////////
var screenarray3=new Array(360);
for (var i=-100;i<460;i++) 
	{
	screenarray3[i]=new Array(360);
	}
for (var j=-100;j<460;j++) 
	{
	for (var i=-100;i<460;i++) 
    	{
	    screenarray3[j][i]=".";//formateja array
	    }
    }
j=180+128;
for (var i=-100;i<460;i++) 
	{
    screenarray3[j][i]="p";//plataforma 1
    }
j=180+128;
for (var i=200;i<280;i++) 
	{
    screenarray3[j][i]=".";//plataforma 1
    }
j=60+128;
for (var i=250;i<460;i++) 
	{
    screenarray3[j][i]="p";//plataforma 2
    } 
j=120+128; 
 for (var i=150;i<250;i++) 
	{
    screenarray3[j][i]="p";//plataforma 3
    }
screenarray3[40+128][280]="h";

var gactor0y=0;
var gactor0x=0;
//Classes for actors ingame
//Runtime actors 
class Actor 
{
	//public ActorHealth = 100; 
    //EnemyArcherExtra1



	constructor(name, x, y, team, mainTexture, InternalTexture, ActorHealth, ActorState ) 
	{

		this.name = name;
		this.x = x; 
		this.y = y;
		this.team = team; //Team 1 Players/hero  Team 2 Enemies
		this.mainTexture = mainTexture;//"BloodForWebGladiators1.png"; 
		this.InternalTexture=new Image();
		this.InternalTexture.setAttribute("src", this.mainTexture);  
		this.ActorHealth = 100; 	
		this.ActorState = "Alive"; //"Alive" is alive, "Dead" is dead
//if(name=="EnemyArcherExtra3"){gactor0y=Math.trunc(y);gactor0x=x;console.log(name + " x:" + x + " y:" + Math.trunc(y));}

	}

 
  //Set location for character sprite
	setLocation(px, py) 
	{
		this.x = px; 
		this.y = py;

   // gactor0y=this.y;///////////////////////////////////////////////////////////////////////////////////////////////////////////////


  
	}
     //WIP
	ActorTakeDamage(DamageAmount)
	{
		this.ActorHealth -= DamageAmount; 
		console.log("FROM Actor taking damage now health is"+this.ActorHealth ); 
		
		if( this.ActorHealth <= 0 && this.ActorState == "Alive" ) 
		{
			this.ActorDie(); 
		}
		
		spawnActor('PlayerBloodParticle', this.x, this.y, 1, "BloodForWebGladiators1.png", "Particle");   //actor 0	 
	}
  
	ActorDie()
	{
		console.log("FROM Actor DYING is"+this.ActorHealth ); 	
		//this.DestroySelf()
		this.ActorSetActorState("Dead");
		this.InternalTexture.setAttribute("src", "GWArcherLoadingArrowDead.png");
		setInterval(this.DestroySelf.bind(this),3000.0); //Find a way to clear the timer
	}
  
	ActorSetActorState(NewActorState)
	{
		this.ActorState = NewActorState; 
		
	}
  
  
 
	ActorTick()
	{
	
		//TestFunction(); 


		if( DoesCollideXYWithXY(this.x, this.y, player_x, player_y, 2, 2 ) )
		{

		    this.CollideOverlap();

	    }
	
	}  
  
	CollideOverlap()
	{

	}
 
	DestroySelf()
	{
		DestroySpecificActorOfTheWorld(this); 
	} 

}


//These are blood or sparks and such
class Pawn extends Actor 
{
	constructor(name, x, y, team, mainTexture, PawnController) 
	{
		super(name, x, y, team, mainTexture, PawnController); 

	}
	
	ActorTick()
	{
	super.ActorTick(); 
	
		if( this.PawnController ) //Valid check here the object exists
		{
			this.x = InterpolateNumbers( this.x, 1, this.PawnController.DesiredLocToGoX );
    //gactor0x=Math.trunc(this.x); 	/////////////////////////////////////////////////////////////////////////////////////////////////////////////////

		}
	}

}

//These are blood or sparks and such
class Knife extends Actor 
{
	constructor(name, x, y, team, mainTexture) 
	{
		super(name, x, y, team, mainTexture); 
	}
	
	

}


//These are blood or sparks and such
class Particle extends Actor 
{
	constructor(name, x, y, team, mainTexture, TimeAlive) 
	{
		super(name, x, y, team, mainTexture);
		this.TimeAlive = TimeAlive;  
		setInterval(this.DestroySelf.bind(this),this.TimeAlive); //Set a timer latent true
	}
	
	ActorTakeDamage(DamageAmount)
	{

	}	

}

//These are projectiles and such
class Projectile extends Actor 
{
	constructor(name, x, y, team, mainTexture, TimeAlive, ProjectileInitSpeedX, ProjectileInitSpeedY) 
	{
		super(name, x, y, team, mainTexture);
		this.TimeAlive = TimeAlive;  
		//setInterval(this.DestroySelf.bind(this),this.TimeAlive); //Set a timer latent true
		this.ProjectileInitSpeedX = ProjectileInitSpeedX; 
		this.ProjectileInitSpeedY = ProjectileInitSpeedY; 

		
	}
  

	CollideOverlap()
	{
		
		
		if(!crouch)
		{		
			if( !protect )
			{
				takeDamage("Hero", 2); 
				this.DestroySelf(); 				
			}
			else
			{
				console.log("FROM actor nice block player "); 
				this.DestroySelf(); 				
			}

		}
		else
		{
			console.log("FROM actor nice crouch player "); 		
		}


	}
 



}



//Controler comes in 2 flavours AI and Player 
class Controller extends Actor 
{
  constructor(name, x, y, team, mainTexture, controlledactor, DesiredLocToGoX, DesiredLocToGoY) 
  {
  super(name, x, y, team, mainTexture);
  this.controlledactor = controlledactor; 
	
  this.DesiredLocToGoX = 0.0; 
  this.DesiredLocToGoY = 0.0;     
  
if(name=="EnemyArcherAIController1"){gactor0y=Math.trunc(y);gactor0x=Math.trunc(x);console.log(name + " x:" +  Math.trunc(x) + " y:" + Math.trunc(y));}	  
  }
  
  posses(possessed)
  {
	this.controlledactor = possessed; 
  }
   
  SetDesiredLocation(PDesiredLocToGoX, PDesiredLocToGoY)
  {
	this.DesiredLocToGoX = PDesiredLocToGoX; 
	this.DesiredLocToGoY = PDesiredLocToGoY; 
  }  
   
   
   
  
}

class AIController extends Controller 
{
  constructor(name, x, y, team, mainTexture, controlledactor, DesiredLocToGoX, DesiredLocToGoY) 
  {
  super(name, x, y, team, mainTexture, controlledactor, DesiredLocToGoX, DesiredLocToGoY);

  setInterval(this.movementtickAI.bind(this),1000); //Set a timer latent true
  setInterval(this.offensivetickAI.bind(this),1000); //Set a timer latent true


  
  }
  movementtickAI()
  {
  //PactorPossessed.setLocation(10, 10); 
  //Set desired location random heres

	  if( getRandomInt(2) == 1 ) 
	  {
		 this.SetDesiredLocation(this.controlledactor.x+getRandomInt(30), this.controlledactor.y+getRandomInt(60)); //Second param should have effect engineer the mechanichs
	  }	
	  else
	  {
		 this.SetDesiredLocation(this.controlledactor.x+getRandomInt(30) *-1, this.controlledactor.y+getRandomInt(60)); 	  
	  
	  }

  }  
  
  offensivetickAI()
  {
  //PactorPossessed.setLocation(10, 10); 
      this.launcharrowpossessed(); 

  }    
  
  launcharrowpossessed()
  {
  
	if( this.controlledactor != null )
	{	
		if( this.controlledactor.ActorState != "Dead"  ) 
		{
			spawnActor('EnemyArcherArrow', this.controlledactor.x, this.controlledactor.y, 1,"fletxa-left.png", "Projectile", null , 5000, -100, 0);   //actor 0 	
		}
	}
  
  }
  
  
}


//Commentar aixo per de espawnajar els arquers, o kualsavol actor
let actorsIngame = [];  //[new actor('name1', 20, 180, 1), new actor('name2', 30, 180, 2), new actor('name3', 40, 180, 2)];

//Neongho: Spawns actor ingame
function spawnActor(name, x,y, team, mainTexture, actorClass, ControlledActor, LifeTimeOfActor, ActorInitialSpeedX, ActorInitialSpeedY)
{

    if( actorClass == "Actor")
	{
	    actorsIngame.push(new Actor(name, x, y, team, mainTexture)); 
	}

    if( actorClass == "Controller")
	{
	    actorsIngame.push(new Controller(name, x, y, team, mainTexture)); //TO FIX
	}


    if( actorClass == "AIController")
	{
	    actorsIngame.push(new AIController(name, x, y, team, mainTexture, ControlledActor)); 
	}

    if( actorClass == "Particle")
	{																   //500 is miliseconds
	    actorsIngame.push(new Particle(name, x, y, team, mainTexture, 500 ) ); //Becareful miliseconds
	}

	if( actorClass == "Projectile" )
	{
	    actorsIngame.push(new Projectile(name, x, y, team, mainTexture, 500, ActorInitialSpeedX, 0 ) ); //Becareful miliseconds			
	}

	if( actorClass == "Pawn" )
	{
	    actorsIngame.push(new Pawn(name, x, y, team, mainTexture ) ); //Becareful miliseconds			
	}

	if( actorClass == "Knife" )
	{
		//console.log("Spawning the knife now"); 
	    actorsIngame.push(new Knife(name, x, y, team, mainTexture ) ); //Becareful miliseconds			
	}



	return actorsIngame[actorsIngame.length-1]; 
}


//Spawn starting actors COMMENTED AS IT IS TO TEST STUFF
//spawnActor('BloodTest', 50, 50, 1, "", "Actor");   //actor 0
//BloodParticoolObject = spawnActor('ControllerOfBlood', 60, 60, 1, "BloodForWebGladiators1.png", "AIController", actorsIngame[0]);  //actor 0  

//spawnActor('EnemyArcherExtra', 50, 50, 1, "ArcherIdle.png", "Actor");   //actor 0 
//spawnActor('BloodTest', 50, 50, 1, "jupiterpower0.png", "AIController", actorsIngame[2]);   //actor 0 


//setInterval( Intervalterminate, 5000 ); 

let ArrowSpawnerTimerHandle = setInterval( AISpawnArrow, 2000 ); 



function Intervalterminate()
{
	DestroySpecificActorOfTheWorld(BloodParticoolObject); 
}


function DestroySpecificActorOfTheWorld(ActorToBeDestroyed) 
{

		
	if( actorsIngame.indexOf(ActorToBeDestroyed) > -1 ) 
	{
		actorsIngame.splice(actorsIngame.indexOf(ActorToBeDestroyed),  1);
		//ActorToBeDestroyed.destroy(); 
	}
}


//Remidner function used for filter actually not understood well
function checkIsIn(objectToDestroy) 
{


  return 1;
}	



//Description: Neongho
//Takes in 
//Param 1 The character gladiator playing anim 
//Param 2 The animation 
//Funct State WIP work in progress, EN PROCESS ENCARA : P 
function PlayAnimation(Character, AnimToPlay)
{
//ctx.drawImage(llanca_right,0,4,20,42,player_x,230,102,84);

}

//Neongho: This is called from button
function MoveRight()
{ 
player_x+=1;
initworkers();  

		let EnemyArcher2 = spawnActor('EnemyArcherExtra2', 0, 0, 2, "ArcherIdle.png", "Pawn");   //Enemy archer 2 

console.log( EnemyArcher2 );


}


function preloader() 
    {
    window.requestAnimationFrame(draw);	
	
	        
	
	
	
    if (document.images) 
        {
        //llanca_right.setAttribute("src", "llanca-right.png");
        //llanca_left.setAttribute("src", "llanca-left.png");
		//llanca_attack.setAttribute("src", "llanca-left.png");
        //arquer_right.setAttribute("src", "arquer-right.png");//jo diria que s ha de treure
        //arquer_left.setAttribute("src", "arquer-left.png");

        archer.setAttribute("src", "ArcherReadyArrowleft.png");
        archerR.setAttribute("src", "ArcherReadyArrow.png");
        hero.setAttribute("src", "MaximusIdle1.PNG");
		herol.setAttribute("src", "MaximusIdle1Left.PNG");
        herowf1.setAttribute("src", "MaximusWalkForward1.PNG");
        herowf2.setAttribute("src", "MaximusWalkForward2.PNG");
        herowf3.setAttribute("src", "MaximusWalkForward3.PNG");
		herowfl1.setAttribute("src", "MaximusWalkForward1Left.PNG");
		herowfl2.setAttribute("src", "MaximusWalkForward2Left.PNG");
		herowfl3.setAttribute("src", "MaximusWalkForward3Left.PNG");			
        column.setAttribute("src", "Col2.png");
        jupiter0.setAttribute("src", "jupiterpower0.png");
        jupiter1.setAttribute("src", "jupiterpower1.png");
        jupiterL.setAttribute("src", "jupiterLeft.png");
        jupiterR.setAttribute("src", "jupiterRight.png");
        heroCI.setAttribute("src", "CrouchIdle.png");
        heroCPA.setAttribute("src", "CrouchPrepareAttack.png");
        heroCUA.setAttribute("src", "CrouchUnleashAttack.png");
        heroSPC.setAttribute("src", "ShieldProtectCrouch.png");
        heroSPS.setAttribute("src", "ShieldProtectStanding.png");
        fletxaL.setAttribute("src", "fletxa-left.png");
        fletxaR.setAttribute("src", "fletxa-right.png");
	    heroAPFLL.setAttribute("src", "MaximusAttackPerpareForwardLeftLeft.png");
		heroAPFL.setAttribute("src", "MaximusAttackUnleashForwardLeft.png");
		heroCIL.setAttribute("src", "CrouchIdleLeft.png");
		heroCPAL.setAttribute("src", "CrouchPrepareAttackLeft.png");
        heroCUAL.setAttribute("src", "CrouchUnleashAttackLeft.png");
        heroSPSL.setAttribute("src", "ShieldProtectStandingLeft.png");
  		heroAPf.setAttribute("src", "MaximusAttackPerpareForwardLeft.png");
 		heroAUf.setAttribute("src", "MaximusAttackUnleashForward.png");
 		coliseum.setAttribute("src", "coliseum.png");
 		columns.setAttribute("src", "columns.png");
        blood.setAttribute("src", "BloodForWebGladiators1.png");
        healthimage.setAttribute("src", "health.png");
        wall.setAttribute("src", "DesolatedHut.png");
        ArcherDead.setAttribute("src", "GWArcherLoadingArrowDead.png");
        glario.setAttribute("src", "glario.png");
        //HUD
		HUDHeroPlayerHP.setAttribute("src", "icon.png");
		HUDEnemyBossHP.setAttribute("src", "iconLeft.png");		
		
	    }
    }
function addLoadEvent(func) 
    {
	
		
	var oldonload = window.onload;
	if (typeof window.onload != 'function') 
        {
		window.onload = func;
	    } 
    else 
        {
    	window.onload = function() 
            {
			if (oldonload) 
                {
				oldonload();
			    }
			func();
		    }
    	}
    }
// PRELOAD IMAGES
addLoadEvent(preloader);
//VARS
let deltaTime = 0;
let lastTimestamp = 0;
const perfectFrameTime = 1000 / 60;
//var lastTimestampint=0;
var screen=0;
var player_x=-30;
var player_y=130;
var gravityw=false;
var crouch=false;
var attack=false;
var go_left=false;
var go_right=false;
//var bAimLeft=false; 
var protect=false;
var AnimationState="Idle";
var velocity_right=0;
var velocity_left=0;
var velocity_attack=0;
var velocity_jupiter=0;
var run_animation_left=0;
var run_animation_right=0;
var run_animation_attack=0;
var run_animation_jupiter=0;
var attack_state=0; //treure
var post_jupiter=false;
var power_jupiter=0;
var enemy_x=260;
var enemy_y=180;
var bFirstenemyDead=true; 
var arrow_x=enemy_x+64;
var heroHealth=100; 
var EnemyArcherHealth=100;
var gameover=false;
var jumping=false;
var to_left=false;
var counterforjump=0;
var fightmode=false;
var timebasejump=0;
var screenArrayNext;
var botiquin0_agafat=false;        
var botiquin1_agafat=false;
var isArcher1=false;
//timers
let NextStageIntervalHandle;
let jupiterIntervalHandle;

// CANVAS
var canvas = document.getElementById('canvas');
if (canvas.getContext) 
    {
    var ctx = canvas.getContext('2d');
    }
// KEYBOARD



document.onkeydown = checkKeyDown;
function checkKeyDown(e) 
    {
 
    if (e.keyCode == '37' ) //left walk //player_x=player_x-5; 
        {  
        go_left=true;crouch=false;attack=false;go_right=false;velocity_right=0; velocity_left=1; velocity_attack=0;to_left=true;
        //if(run_animation_left==2){run_animation_left=0;}else{run_animation_left++;}
        if(Math.trunc(lastTimestamp/100) % 2){run_animation_left=0;}else{run_animation_left=1}
        
        }
    if (e.keyCode == '39' ) //right walk player_x=player_x+5;
        {   
        go_left=false;go_right=true;crouch=false;attack=false;go_left=false; velocity_right=1; velocity_left=0; velocity_attack=0;to_left=false;
        //if(run_animation_right==2){run_animation_right=0;}else{run_animation_right++;}
        if(Math.trunc(lastTimestamp/100) % 2){run_animation_right=0;}else{run_animation_right=1}
        }
    if (e.keyCode == '38' && timebasejump==0) //up cursor
        {
        
        timebasejump=lastTimestamp;
        if(timebasejump+4000>lastTimestamp)jumping=true;else{jumping=false;timebasejump=0}
        }
    if (e.keyCode == '40') //down cursor
        {
        go_left=false;go_right=false;crouch=true;attack=false;go_left=false; velocity_right=0; velocity_left=0; velocity_attack=0;
	    if(Math.trunc(lastTimestamp/100) % 2){run_animation_jupiter=0;}else{run_animation_jupiter=1;}           
	    }
    if (e.keyCode == '88') //x attack
        {
        go_left=false; go_right=false; crouch=false; attack=true; velocity_right=0; velocity_left=0; velocity_attack=2;run_animation_attack=0;power_jupiter=power_jupiter+0.2;     
	    if(Math.trunc(lastTimestamp/100) % 2){run_animation_jupiter=0;playerLoadingJupiter();}else{run_animation_jupiter=1;}    

        } 
	
    if (e.keyCode == '90') //z attack
        {
        if (crouch==true)//crouch z atack
            {
            go_left=false; go_right=false;attack=true; velocity_right=0; velocity_left=0; velocity_attack=1;
	        if(Math.trunc(lastTimestamp/200) % 2){run_animation_attack=0;}else{run_animation_attack=1;}       
            }
        else
            {//z attack
            go_left=false; go_right=false; crouch=false; attack=true; velocity_right=0; velocity_left=0; velocity_attack=1; ;      
	        

			if(Math.trunc(lastTimestamp/200) % 2)
			{
				run_animation_attack=0;
				PlayerUnleashAttack("Normal")

			}
			else
			{
				run_animation_attack=1;

			}       
            }
        }
    if (e.keyCode == '67') //c Protect
        {
        protect = true;
 		
        }				
		
		
		
    if (e.keyCode == '13' && gameover==false  && screen==-1) //enter
        {
        SetSpecificStage(-0.5);
        initworkers();    


        }
    
if (e.keyCode == '13' && gameover==true && screen==-2) //enter
        {
        screen=-1;        
        gameover=false;
        deltaTime = 0;
        lastTimestamp = 0;
//const perfectFrameTime = 1000 / 60;
//var lastTimestampint=0;
        player_x=-30;
        player_y=0;
        crouch=false;
        attack=false;
        go_left=false;
        go_right=false;
//var bAimLeft=false; 
        protect=false;
        AnimationState="Idle";
        velocity_right=0;
        velocity_left=0;
        velocity_attack=0;
        velocity_jupiter=0;
        run_animation_left=0;
        run_animation_right=0;
       run_animation_attack=0; 
        run_animation_jupiter=0;
        attack_state=0; //treure
        post_jupiter=false;
        power_jupiter=0;
        enemy_x=260;
                enemy_y=180;
        arrow_x=enemy_x+64;
        heroHealth=100; 
        EnemyArcherHealth=100;
        }
    
    }
document.onkeyup = checkKeyUp;
//ON RELASE
function checkKeyUp(e) 
    {
    if (e.keyCode == '37') //left cursor
        {
        go_left=false;
        velocity_left=0;
		//bAimLeft=true; 		
        }
    if (e.keyCode == '39') //right cursor
        {   
        go_right=false;       
        velocity_right=0;
		//bAimLeft=false; 
        }
    if (e.keyCode == '38') //up cursor
        {
        jumping=false;timebasejump=0;
        }
    if (e.keyCode == '40') //down cursor
        {
        crouch=false;  
        }
    if (e.keyCode == '88') //x
        {

        post_jupiter=true;
        velocity_attack=0;
        attack = false;	
		PlayerUnleashAttack("Jupiter"); 	
        }
    if (e.keyCode == '90') //z
        {


        velocity_attack=0;
        attack = false;		
        }
    if (e.keyCode == '67') //c Protect
        {
        protect = false; 
        }		
		
		
		
    if (e.keyCode == '13') //enter
        {
        
        }
    }
	
function draw(timestamp) 
    {	
    requestAnimationFrame(draw);
    deltaTime = (timestamp - lastTimestamp) / perfectFrameTime;

//console.log("y: " + gactor0y);        


	if (heroHealth<=0){gameover=true;screen=-2}	
	
	
	
	
	
    if (EnemyArcherHealth<=0 && screen==1)     
        {
        //screen=1;
		
		if( NextStageIntervalHandle == null )
		{
			//NextStageIntervalHandle = setInterval( SetNextStage, 3000  ); 
		}
		
		
        fightmode=false;

        }	
		
		
		
		
    //clean canvas screen
    canvas.width=canvas.width;
    //screen
    ctx.beginPath();

    ctx.drawImage(wall,0,0,500,500,0*i,0*j,90,90);
    
    

	
	
 
 
 
 
    if(screen==-1)
        {
     for (i=0;i<4;i++)
        {
        for(j=0;j<4;j++)
            {
            ctx.drawImage(wall,0,0,500,500,0*i,0*j,90,90);
            ctx.drawImage(wall,0,0,500,500,90*i,0*j,90,90);
            ctx.drawImage(wall,0,0,500,500,0*i,90*j,90,90);
            ctx.drawImage(wall,0,0,500,500,90*i,90*j,90,90);
            }
        }
        ctx.drawImage(glario,0,0,360,100,0,0,360,100);
        ctx.drawImage(herol,0,0,128,128,260,160,128,128);
        ctx.fillStyle = 'white';
        ctx.font = "30px arial";
        //ctx.fillText("Glario:", 10, 30);
        //ctx.font = "20px arial";
        //ctx.fillText("Controls", 10, 110);
        ctx.fillText("Controls:", 10, 130);
        ctx.font = "20px arial";
        ctx.fillText("up arrow -> levitation/jump", 10, 155);
        ctx.fillText("down arrow -> crouch", 10, 175);
        ctx.fillText("left arrow -> walk to left", 10, 195);
        ctx.fillText("right arrow -> walk to right", 10, 215);
        ctx.fillText("z -> attack", 10, 235);
        ctx.fillText("x -> jupiter attack", 10, 255);
        ctx.fillText("c -> protect", 10, 275);
        ctx.fillText("escape -> leave game", 10, 295);
        //ctx.fillText("-------------------------------------", 10, 310);
        ctx.font = "30px arial";
        ctx.fillText("Press enter to start", 10, 345);
        
        }

     if(screen>-1)
     {

     for (i=0;i<4;i++)
        {
        for(j=0;j<4;j++)
            {
            ctx.drawImage(wall,0,0,500,500,0*i,0*j,90,90);
            ctx.drawImage(wall,0,0,500,500,90*i,0*j,90,90);
            ctx.drawImage(wall,0,0,500,500,0*i,90*j,90,90);
            ctx.drawImage(wall,0,0,500,500,90*i,90*j,90,90);
            }
        }
     }  ///wall
     
     
		for (var j=0;j<360;j++) 
		{
			for (var i=0;i<360;i++) 
			{
				if (screenarray3[j][i]=="p"){ctx.fillStyle = 'brown';ctx.fillRect(i,j,1,10);}
				if (screenarray3[j][i]=="h"&& botiquin1_agafat==false){ctx.drawImage(healthimage,0,0,20,20,i,j,20,20);}
				
			}
		} 
        


    //enemy
    //if(screen==0 && enemy_x>=player_x){ctx.drawImage(archer,0,0,128,128,enemy_x,enemy_y,128,128);} 
    //if(screen==0 && enemy_x<player_x){ctx.drawImage(archerR,0,0,128,128,enemy_x,enemy_y,128,128);}
 
    //player
    if(screen>-1 && crouch==false && attack==false && protect==false && go_left==false && go_right==false && velocity_right==0 && post_jupiter==false && enemy_x>=player_x) 
    {ctx.drawImage(hero,0,0,128,128,player_x,player_y,128,128)} //idle



	if( player_y < 180 ) //Gravity threshold
	{
		//player_y = player_y+1;
	}
  
  
   //if(screen>-1 && enemy_x>player_x){ctx.drawImage(fletxaL,0,0,20,5,arrow_x,220,20,5);}
      //arrow left
   //if(screen>-1 && enemy_x<=player_x){ctx.drawImage(fletxaR,0,0,20,5,arrow_x,220,20,5);}
    //xivatos de variables
   if(screen>-1)
        {
/*          ctx.fillStyle = 'white';
        ctx.font = "20px arial";
        ctx.fillText("screen:" + screen, 10, 20);
        ctx.fillText("power_jupiter:" + power_jupiter, 10, 40);
        ctx.fillText("timestamp:" + lastTimestamp, 10, 120);
        ctx.fillText("timebasejump:" + (timebasejump), 10, 140);
        ctx.fillText("HeroHealth :" + heroHealth, 10, 60);
        ctx.fillText("Enemy ArcherHealth:" + EnemyArcherHealth, 10, 80);		
		ctx.fillText("fightmode:" + fightmode, 10, 100);*/
		}
//////////////////////////////////////////////////////////       
   if( DoesArrowCollideWithAnyone() || DoesArrowCollideWithAnyoneInvertedOrder()){ }   //takeDamage("Hero", 0.05);          
   if( DoesPlayerIsInAttackProximity() || DoesPlayerIsInAttackProximityInvertedOrder()){   } 
   if( DoesSwordCollideWithAnyone() || DoesSwordCollideWithAnyoneInvertedOrder()){    }
   if( DoesJupiterCollideWithAnyone() || DoesJupiterCollideWithAnyoneInvertedOrder())
   {  

   //takeDamage("EnemyArcher",power_jupiter);   
  

   
   }
   


		actorsIngame.forEach(DrawActors);
		function DrawActors(value, index, array) 
		{
			ctx.drawImage(value.InternalTexture,0,0,128,128,value.x,value.y,128,128);
			value.ActorTick();
			console.log('drawing actor'+value.name);

			if( value.constructor.name  == "Pawn" )  //To know if is projectile
			{
			    if( true ) //!bIsOnFloorAlready(value) ) 
				{

					
					if( value.name == "EnemyArcherExtra1") 
					{
						//console.log(" hello there EnemyArcherExtra1 ticking "+value.y ); 
						 //Archer1actor_y = value.y; 
						value.y = Archer1actor_y;
						Archer1actor_x=value.x; 
						
					} 
					else
					{
						//value.y = value.y + 1;				
					
					}
					
				}
			}			
			
			if( value.constructor.name  == "Projectile" )  //To know if is projectile
			{
			   value.x += value.ProjectileInitSpeedX/100; 
			}

			if( value.constructor.name  == "Knife" )  //To know if is projectile
			{
			    if( !KnifeIsOnFloorAlready(value) ) 
				{
					value.y = value.y + 4; 
				}
			}

		}		
		


	lastTimestamp = timestamp;	
    } //End draw
	


	
// INIT workers
function initworkers()
    {
	
    if (gravityworker!==undefined){gravityworker.terminate();}
    gravityworker=undefined;	
	init_gravityworker();
    gravityworker.postMessage({ player_y: player_y, screen: screen, jumping: jumping});	
            console.log('starting the workers');	
    }
	
var gravityworker;
function init_gravityworker() 
    {
    if (typeof(Worker) !== "undefined") 
        {
        if (typeof(gravityworker) == "undefined") 
            {
            gravityworker = new Worker("gravityworker.js");
            }
        gravityworker.onmessage = function(event_gravityworker) 
            {        
            player_y=event_gravityworker.data.player_y;
            if(screen==-0.5){screenArrayNext=screenarray1[player_y-1+120][player_x+64];}
            if(screen==0){screenArrayNext=screenarray2[player_y-1+120][player_x+64];}
            if(screen==1){screenArrayNext=screenarray3[player_y-1+120][player_x+64];}
            if(screen==2){screenArrayNext=screenarray1[player_y-1+120][player_x+64];}
            //if(screen==3){screenArrayNext=screenarray2[player_y-1+120][player_x+64];}
            //if(screen==4){screenArrayNext=screenarray3[player_y-1+120][player_x+64];}           
            gravityworker.postMessage({screen: screen, player_y: player_y, jumping: jumping, screenArrayNext: screenArrayNext});
            console.log('starting the worker');
            
            };
        
        }
    }
	
	
	
//Neongho: Who ever takes damage this function will be responsible for applying it
//1 hero is the player
//2 Enemy Archer is archer
function takeDamage(PCharacter, PDamageAmount)
{
	
	if( PCharacter == "Hero")
	{
		heroHealth = heroHealth - PDamageAmount;
		spawnActor('PlayerBloodParticle', player_x, player_y, 1, "BloodForWebGladiators1.png", "Particle");   //actor 0		
	}		
		
	if( PCharacter == "EnemyArcher") 
	{
		EnemyArcherHealth = EnemyArcherHealth - PDamageAmount;
		spawnActor('EnemyBloodParticle', enemy_x, enemy_y, 2, "BloodForWebGladiators1.png", "Particle");   //actor 0
	}
	
}

function DoesArrowCollideWithAnyone()
{
	if( player_x - arrow_x >-50 && player_x - arrow_x < 50) 
	{
	return true;	  			
	}
	else
	{
	return false;			
	}

return true; 
}

function DoesPlayerIsInAttackProximity()
{
	
	if( player_x - enemy_x >-50 && player_x - enemy_x < 50) 
	{
	return true;				
	}
	else
	{
	return false;			
	}
	
return true; 
}
function DoesSwordCollideWithAnyone()
{
	if(player_x - enemy_x >-100 && player_x - enemy_x < 0  && attack==true && post_jupiter==false) 
	{
	return true;	  			
	}
	else
	{
	return false;			
	}

return true; 
}
function DoesJupiterCollideWithAnyone()
{
	if(player_x - enemy_x >-100 && player_x - enemy_x < 0  && power_jupiter>0 && post_jupiter==true) 
	{
	return true;	  			
	}
	else
	{
	return false;			
	}

return true; 
}
function DoesArrowCollideWithAnyoneInvertedOrder()
{
	if( -player_x + arrow_x >-50 && -player_x + arrow_x < 50)
	{
	return true;	  			
	}
	else
	{
	return false;			
	}

return true; 
}

function DoesPlayerIsInAttackProximityInvertedOrder()
{
	
	if( -player_x + enemy_x >-50 && -player_x + enemy_x < 50) 
	{
	return true;				
	}
	else
	{
	return false;			
	}
	
return true; 
}
function DoesSwordCollideWithAnyoneInvertedOrder()
{
	if( -player_x + enemy_x >-100 && -player_x + enemy_x < 0  && attack==true && post_jupiter==false) 
	{
	return true;	  			
	}
	else
	{
	return false;			
	}

return true; 
}


//Math functions ------------------------------------//

//Neongho; Function that returns the size of something and if collides
function DoesCollideXYWithXY( X1, Y1, X2, Y2, Size1, Size2 ) 
{
	if( X1 > 0 && X2 > 0 ) //Make sure it is not outside screen
	{
		if( Math.abs( Math.abs(X1) - Math.abs(X2) ) < Size1 + Size2 ) 
		{
			return true; 
		}
	}
}

//Neongho; it will interpolate 2 numbers WIP
function InterpolateNumbers(ActualNumber, InterpSpeed, FinalNumber )
{
var ReturniveNumber;

    return ActualNumber + ((ActualNumber/99) * (FinalNumber-ActualNumber));
}

//Neongho: These is to get random numbers
function getRandomInt(max) 
{
  return Math.floor(Math.random() * max);
}





//Math functions ------------------------------------//




function playerLoadingJupiter()
{ 
jupiterloading.play();


}

function DoesJupiterCollideWithAnyoneInvertedOrder()
{
	if( -player_x + enemy_x >-100 && -player_x + enemy_x < 0  && power_jupiter>0 && post_jupiter==true) 
	{
	return true;	  			
	}
	else
	{
	return false;			
	}

return true; 
}

//Agresive functions attack functions
function PlayerUnleashAttack( TypeOfAttack )
{  

	if( TypeOfAttack == "Normal")
	{
	   if(run_animation_attack==0){audiosword2.play();}
       if( DoesPlayerIsInAttackProximity() )
	   {     
		   takeDamage("EnemyArcher", 5); 	
       }
	   
		actorsIngame.forEach(CheckAttackForActors);
		function CheckAttackForActors(value, index, array) 
		{
			
			if( value != null ) 
			{
				if( DoesCollideXYWithXY(player_x, player_y, value.x, value.y, 20, 20)    )  //Do that Y is also a variable of proximity when colliding
				{
					value.ActorTakeDamage(25); 
				}	
			}

		}		
	   
	   

	   
	}



	if( TypeOfAttack == "Jupiter")
	{
	audiosword.play();
       if( DoesPlayerIsInAttackProximity() )
	   {     
		   takeDamage("EnemyArcher", power_jupiter *10); 	 //Neongho added *10
       }
	}


return true; 
}
//For specific next stage to go at 
function SetNextStage()
{

	//screen++; 
	clearInterval(NextStageIntervalHandle); 
	HandleNewStage(screen); 	
	
}
//For specific stage to go at 
function SetSpecificStage(NewStage)
{

	screen = NewStage; 
	HandleNewStage(NewStage); 

}

function HandleNewStage(NewStage) 
{
 

	if( NewStage == -0.5 ) 
	{
	//	spawnActor('Knife', 175, 0, 2, "Knife.png","Knife" );  
	}

	if( NewStage == 0 ) 
	{

	
	}
	if( NewStage == 1 ) 
	{
		
		Archer1actor_y = 0; 
		let EnemyArcher1 = spawnActor('EnemyArcherExtra1', 50, 80, 2, "ArcherIdle.png", "Pawn");   //Enemy archer 1
		let EnemyArcher1AI = spawnActor('EnemyArcherAIController1', 0, 0, 2, "jupiterpower0.png", "AIController", EnemyArcher1);   //AIController evil of archer
		EnemyArcher1AI.DesiredLocToGoX = EnemyArcher1.x; EnemyArcher1AI.DesiredLocToGoY = EnemyArcher1.y; 
		EnemyArcher1.PawnController = EnemyArcher1AI;  

    if (gravityactorsworker!==undefined){gravityactorsworker.terminate();}
    gravityactorsworker=undefined;
    init_gravityactorsworker(); 
    gravityactorsworker.postMessage({ Archer1actor_y: Archer1actor_y});


		
		console.log(" FROM Stage 1 the archer actor is  "+Archer1actor_y); 

		let EnemyArcher2 = spawnActor('EnemyArcherExtra2', 60, 80, 2, "ArcherIdle.png", "Pawn");   //Enemy archer 2 
		let EnemyArcher2AI = spawnActor('EnemyArcherAIController2', 0, 0, 2, "jupiterpower0.png", "AIController", EnemyArcher2);   //AIController evil of archer		
		EnemyArcher2AI.DesiredLocToGoX = EnemyArcher2.x; EnemyArcher2AI.DesiredLocToGoY = EnemyArcher2.y; 		
		EnemyArcher2.PawnController = EnemyArcher2AI;  		
		
		let EnemyArcher3 = spawnActor('EnemyArcherExtra3', 70, 80, 2, "ArcherIdle.png", "Pawn");   //Enemy archer 3 	
		let EnemyArcher3AI = spawnActor('EnemyArcherAIController3', 0, 0, 2, "jupiterpower0.png", "AIController", EnemyArcher3);   //AIController evil of archer	
		EnemyArcher3AI.DesiredLocToGoX = EnemyArcher3.x; EnemyArcher3AI.DesiredLocToGoY = EnemyArcher3.y; 		
		EnemyArcher3.PawnController = EnemyArcher3AI; 

        //gactor0y=Math.trunc(EnemyArcher1.y);gactor0x=Math.trunc(EnemyArcher1.x);console.log(name + " x:" + Math.trunc(EnemyArcher1.x) + " y:" + Math.trunc(EnemyArcher1.y));



	}
	if( NewStage == 2 ) 
	{
	
	
	}
}

function bIsOnFloorAlready(ActorChecking)
{
//if(name=="EnemyArcherExtra3"){gactor0y=Math.trunc(y);gactor0x=x;console.log(name + " x:" + x + " y:" + Math.trunc(y));}
//if(name=="EnemyArcherExtra3"){gactor0y=Math.trunc(y);gactor0x=x;console.log(name + " x:" + x + " y:" + Math.trunc(y));}

	if( ActorChecking.y >= 190 )  //190
	{
		return true; 	
	}
	else 
	{
		return false; 	
	}


}





function KnifeIsOnFloorAlready(ActorChecking)
{



	if( ActorChecking.y >= 277 )  
	{
		return true; 	
	}
	else 
	{
		return false; 	
	}


}

function AISpawnArrow()
{



	if(screen > -0.5) 
	{
	
		if( enemy_x > player_x  ) 
		{
			spawnActor('EnemyArcherArrow', enemy_x, 220, 1,"fletxa-left.png", "Projectile", null , 5000, -100, 0);   //actor 0 			
		}
		else 
		{
			spawnActor('EnemyArcherArrow', enemy_x, 220, 1,"fletxa-right.png", "Projectile", null , 5000, 100, 0);   //actor 0 			
		}
		
		
				//clearInterval(ArrowSpawnerTimerHandle); 
		
	}

}

//Neongho: mira si esta a un costat si ho esta dona veritat si no falsatat total WIP not sure if is done
//-60 left, 300 right return true is left return false is right
function returnscreensideweare(Kind, ActorAtExtreme)
{

	if( Kind == "Player" ) 
	{
		if( player_x < 120  ) 
		{
			return true; 	//Is  on left		
		}
		else
		{
			return false; //Is  on right		
		}
		

	}
	if( Kind == "Actor" ) 
	{
		//Use actor here ActorAtExtreme x and y
		return true; 
	}
}

//Neongho: mira si esta a un costat si ho esta dona veritat si no falsatat total
//-60 left, 300 right costa dentendre en realitat bExtremLeft es going right
function IsOnExtremOfPantalla(Kind, ActorAtExtreme, bGoingRight)
{


	if( Kind == "Player" ) 
	{
		if( player_x < -60 && bGoingRight ) 
		{
			return true; 			
		}
		else 
		{
			if( player_x > 290 && !bGoingRight &&  screen > 2)  //!ScreenCompletedEmpty[screen]
			{

			
			
				return true; 			
			}
		
		
			return false; 
		}
		

	}
	if( Kind == "Actor" ) 
	{
		//Use actor here ActorAtExtreme x and y
		return true; 
	}

	return false; 
}

function IsScreenEmptyOfEnemiesComplete()
{

	return true; 
}




</script>



</html>
